# SPDX-License-Identifier: (GPL-2.0-only OR BSD-2-Clause)

%YAML 1.2
---
$id: "http://devicetree.org/schemas/media/mediatek,vcodec-comp-decoder.yaml#"
$schema: "http://devicetree.org/meta-schemas/core.yaml#"

title: Mediatek Video Decode Accelerator With Multi Hardware

maintainers:
  - Yunfei Dong <yunfei.dong@mediatek.com>

description: |
  Mediatek Video Decode is the video decode hardware present in Mediatek
  SoCs which supports high resolution decoding functionalities. Required
  master and component node.

  About the Decoder Hardware Block Diagram, please check below:

    +---------------------------------+------------------------------------+
    |                                 |                                    |
    | input -> lat HW -> lat buffer --|--> lat buffer -> core HW -> output |
    |            ||                   |                     ||             |
    +------------||-------------------+---------------------||-------------+
                 ||       lat thread  |  core thread        ||     <master>
    -------------||-----------------------------------------||----------------
                 ||                                         ||     <component>
                 \/ <----------------HW index-------------->\/
           +------------------------------------------------------+
           |                    enable/disable                    |
           |           clk     power    irq    iommu port         |
           |                 (lat/lat soc/core0/core1)            |
           +------------------------------------------------------+

  As above, <master> mean in master device, <component> mean in component device.
  The information of each hardware will be stored in each component device. There
  are two workqueue in master device: lat and core. Enable/disable the lat clk/power/irq
  when lat hardware need to work through hardware index, core is the same.

  Normally the smi common may not the same for each hardware, can't combine all
  hardware in one node, or leading to iommu fault when access dram data.

properties:
  compatible:
    const: mediatek,mt8192-vcodec-dec

  reg:
    maxItems: 1

  iommus:
    minItems: 1
    maxItems: 32
    description: |
      List of the hardware port in respective IOMMU block for current Socs.
      Refer to bindings/iommu/mediatek,iommu.yaml.

  mediatek,scp:
    $ref: /schemas/types.yaml#/definitions/phandle
    maxItems: 1
    description: |
      The node of system control processor (SCP), using
      the remoteproc & rpmsg framework.
      $ref: /schemas/remoteproc/mtk,scp.yaml

  dma-ranges:
    maxItems: 1
    description: |
      Describes the physical address space of IOMMU maps to memory.

  "#address-cells":
    const: 1

  "#size-cells":
    const: 1

  ranges: true

# Required child node:
patternProperties:
  vcodec-lat:
    type: object

    properties:
      compatible:
        const: mediatek,mtk-vcodec-lat

      reg:
        maxItems: 1

      reg-names:
        maxItems: 1

      interrupts:
        maxItems: 1

      iommus:
        minItems: 1
        maxItems: 32
        description: |
          List of the hardware port in respective IOMMU block for current Socs.
          Refer to bindings/iommu/mediatek,iommu.yaml.

      clocks:
        maxItems: 5

      clock-names:
        items:
          - const: vdec-sel
          - const: vdec-soc-vdec
          - const: vdec-soc-lat
          - const: vdec-vdec
          - const: vdec-top

      assigned-clocks:
        maxItems: 1

      assigned-clock-parents:
        maxItems: 1

      power-domains:
        maxItems: 1

    required:
      - compatible
      - reg
      - reg-names
      - interrupts
      - iommus
      - clocks
      - clock-names
      - assigned-clocks
      - assigned-clock-parents
      - power-domains

    additionalProperties: false

  vcodec-core:
    type: object

    properties:
      compatible:
        const: mediatek,mtk-vcodec-core

      reg:
        maxItems: 1

      reg-names:
        maxItems: 1

      interrupts:
        maxItems: 1

      iommus:
        minItems: 1
        maxItems: 32
        description: |
          List of the hardware port in respective IOMMU block for current Socs.
          Refer to bindings/iommu/mediatek,iommu.yaml.

      clocks:
        maxItems: 5

      clock-names:
        items:
          - const: vdec-sel
          - const: vdec-soc-vdec
          - const: vdec-soc-lat
          - const: vdec-vdec
          - const: vdec-top

      assigned-clocks:
        maxItems: 1

      assigned-clock-parents:
        maxItems: 1

      power-domains:
        maxItems: 1

    required:
      - compatible
      - reg
      - reg-names
      - interrupts
      - iommus
      - clocks
      - clock-names
      - assigned-clocks
      - assigned-clock-parents
      - power-domains

    additionalProperties: false

required:
  - compatible
  - reg
  - iommus
  - mediatek,scp
  - dma-ranges
  - ranges

additionalProperties: false

examples:
  - |
    #include <dt-bindings/interrupt-controller/arm-gic.h>
    #include <dt-bindings/memory/mt8192-larb-port.h>
    #include <dt-bindings/interrupt-controller/irq.h>
    #include <dt-bindings/clock/mt8192-clk.h>
    #include <dt-bindings/power/mt8192-power.h>

    vcodec_dec: vcodec_dec@16000000 {
        compatible = "mediatek,mt8192-vcodec-dec";
        reg = <0x16000000 0x1000>;		/* VDEC_SYS */
        mediatek,scp = <&scp>;
        iommus = <&iommu0 M4U_PORT_L4_VDEC_MC_EXT>;
        dma-ranges = <0x1 0x0 0x0 0x40000000 0x0 0xfff00000>;
        #address-cells = <1>;
        #size-cells = <1>;
        ranges;
        lat: vcodec-lat@16010000 {
            compatible = "mediatek,mtk-vcodec-lat";
            reg = <0x16010000 0x800>;
            reg-names = "misc";
            interrupts = <GIC_SPI 426 IRQ_TYPE_LEVEL_HIGH 0>;
            iommus = <&iommu0 M4U_PORT_L5_VDEC_LAT0_VLD_EXT>,
                <&iommu0 M4U_PORT_L5_VDEC_LAT0_VLD2_EXT>,
                <&iommu0 M4U_PORT_L5_VDEC_LAT0_AVC_MV_EXT>,
                <&iommu0 M4U_PORT_L5_VDEC_LAT0_PRED_RD_EXT>,
                <&iommu0 M4U_PORT_L5_VDEC_LAT0_TILE_EXT>,
                <&iommu0 M4U_PORT_L5_VDEC_LAT0_WDMA_EXT>,
                <&iommu0 M4U_PORT_L5_VDEC_LAT0_RG_CTRL_DMA_EXT>,
                <&iommu0 M4U_PORT_L5_VDEC_UFO_ENC_EXT>;
            clocks = <&topckgen CLK_TOP_VDEC_SEL>,
                <&vdecsys_soc CLK_VDEC_SOC_VDEC>,
                <&vdecsys_soc CLK_VDEC_SOC_LAT>,
                <&vdecsys_soc CLK_VDEC_SOC_LARB1>,
                <&topckgen CLK_TOP_MAINPLL_D4>;
            clock-names = "vdec-sel", "vdec-soc-vdec", "vdec-soc-lat",
                "vdec-vdec", "vdec-top";
            assigned-clocks = <&topckgen CLK_TOP_VDEC_SEL>;
            assigned-clock-parents = <&topckgen CLK_TOP_MAINPLL_D4>;
            power-domains = <&spm MT8192_POWER_DOMAIN_VDEC>;
        };

        core: vcodec-core@16025000 {
            compatible = "mediatek,mtk-vcodec-core";
            reg = <0x16025000 0x1000>;
            reg-names = "misc";
            interrupts = <GIC_SPI 425 IRQ_TYPE_LEVEL_HIGH 0>;
            iommus = <&iommu0 M4U_PORT_L4_VDEC_MC_EXT>,
                <&iommu0 M4U_PORT_L4_VDEC_UFO_EXT>,
                <&iommu0 M4U_PORT_L4_VDEC_PP_EXT>,
                <&iommu0 M4U_PORT_L4_VDEC_PRED_RD_EXT>,
                <&iommu0 M4U_PORT_L4_VDEC_PRED_WR_EXT>,
                <&iommu0 M4U_PORT_L4_VDEC_PPWRAP_EXT>,
                <&iommu0 M4U_PORT_L4_VDEC_TILE_EXT>,
                <&iommu0 M4U_PORT_L4_VDEC_VLD_EXT>,
                <&iommu0 M4U_PORT_L4_VDEC_VLD2_EXT>,
                <&iommu0 M4U_PORT_L4_VDEC_AVC_MV_EXT>,
                <&iommu0 M4U_PORT_L4_VDEC_RG_CTRL_DMA_EXT>;
            clocks = <&topckgen CLK_TOP_VDEC_SEL>,
                <&vdecsys CLK_VDEC_VDEC>,
                <&vdecsys CLK_VDEC_LAT>,
                <&vdecsys CLK_VDEC_LARB1>,
                <&topckgen CLK_TOP_MAINPLL_D4>;
            clock-names = "vdec-sel", "vdec-soc-vdec", "vdec-soc-lat",
                "vdec-vdec", "vdec-top";
            assigned-clocks = <&topckgen CLK_TOP_VDEC_SEL>;
            assigned-clock-parents = <&topckgen CLK_TOP_MAINPLL_D4>;
            power-domains = <&spm MT8192_POWER_DOMAIN_VDEC2>;
        };
    };
