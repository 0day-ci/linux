# SPDX-License-Identifier: GPL-2.0-or-later
# Copyright 2019 IBM Corp.
%YAML 1.2
---
$id: http://devicetree.org/schemas/mmc/aspeed,sdhci.yaml#
$schema: http://devicetree.org/meta-schemas/core.yaml#

title: ASPEED SD/SDIO/MMC Controller

maintainers:
  - Andrew Jeffery <andrew@aj.id.au>
  - Ryan Chen <ryanchen.aspeed@gmail.com>

description: |+
  The ASPEED SD/SDIO/eMMC controller exposes two slots implementing the SDIO
  Host Specification v2.00, with 1 or 4 bit data buses, or an 8 bit data bus if
  only a single slot is enabled.

  The two slots are supported by a common configuration area. As the SDHCIs for
  the slots are dependent on the common configuration area, they are described
  as child nodes.

  The signal voltage of SDHCIs on AST2600-A2 EVB is able to be toggled by GPIO
  pins. In the reference design, GPIOV0 of AST2600-A2 EVB is connected to the
  power load switch that providing 3.3v to SD1 bus vdd, GPIOV1 is connected to
  a 1.8v and a 3.3v power load switch that providing signal voltage to
  SD1 bus.
  If GPIOV0 is active high, SD1 bus is enabled. Otherwise, SD1 bus is
  disabled. If GPIOV1 is active high, 3.3v power load switch is enabled, SD1
  signal voltage is 3.3v. Otherwise, 1.8v power load switch will be enabled, SD1
  signal voltage becomes 1.8v.
  AST2600-A2 EVB also support toggling signal voltage for SD2 bus.
  The design is the same as SD1 bus. It uses GPIOV2 as power-gpio and GPIOV3
  as power-switch-gpio.

properties:
  compatible:
    enum:
      - aspeed,ast2400-sd-controller
      - aspeed,ast2500-sd-controller
      - aspeed,ast2600-sd-controller
  reg:
    maxItems: 1
    description: Common configuration registers
  "#address-cells":
    const: 1
  "#size-cells":
    const: 1
  ranges: true
  clocks:
    maxItems: 1
    description: The SD/SDIO controller clock gate

patternProperties:
  "^sdhci@[0-9a-f]+$":
    type: object
    $ref: mmc-controller.yaml

    properties:
      compatible:
        enum:
          - aspeed,ast2400-sdhci
          - aspeed,ast2500-sdhci
          - aspeed,ast2600-sdhci
      reg:
        maxItems: 1
        description: The SDHCI registers
      clocks:
        maxItems: 1
        description: The SD bus clock
      interrupts:
        maxItems: 1
        description: The SD interrupt shared between both slots
      sdhci,auto-cmd12:
        type: boolean
        description: Specifies that controller should use auto CMD12
    required:
      - compatible
      - reg
      - clocks
      - interrupts

additionalProperties: false

required:
  - compatible
  - reg
  - "#address-cells"
  - "#size-cells"
  - ranges
  - clocks

examples:
  //Example 1
  - |
    #include <dt-bindings/clock/aspeed-clock.h>
    sdc@1e740000 {
            compatible = "aspeed,ast2500-sd-controller";
            reg = <0x1e740000 0x100>;
            #address-cells = <1>;
            #size-cells = <1>;
            ranges = <0 0x1e740000 0x20000>;
            clocks = <&syscon ASPEED_CLK_GATE_SDCLK>;

            sdhci0: sdhci@100 {
                    compatible = "aspeed,ast2500-sdhci";
                    reg = <0x100 0x100>;
                    interrupts = <26>;
                    sdhci,auto-cmd12;
                    clocks = <&syscon ASPEED_CLK_SDIO>;
            };

            sdhci1: sdhci@200 {
                    compatible = "aspeed,ast2500-sdhci";
                    reg = <0x200 0x100>;
                    interrupts = <26>;
                    sdhci,auto-cmd12;
                    clocks = <&syscon ASPEED_CLK_SDIO>;
            };
    };

  //Example 2 (AST2600EVB with GPIO regulator)
  - |
    #include <dt-bindings/clock/aspeed-clock.h>
    #include <dt-bindings/gpio/aspeed-gpio.h>
    vcc_sdhci0: regulator-vcc-sdhci0 {
            compatible = "regulator-fixed";

            regulator-name = "SDHCI0 Vcc";
            regulator-min-microvolt = <3300000>;
            regulator-max-microvolt = <3300000>;
            gpios = <&gpio0 ASPEED_GPIO(V, 0)
                            GPIO_ACTIVE_HIGH>;
            enable-active-high;
    };

    vccq_sdhci0: regulator-vccq-sdhci0 {
            compatible = "regulator-gpio";

            regulator-name = "SDHCI0 VccQ";
            regulator-min-microvolt = <1800000>;
            regulator-max-microvolt = <3300000>;
            gpios = <&gpio0 ASPEED_GPIO(V, 1)
                            GPIO_ACTIVE_HIGH>;
            gpios-states = <1>;
            states = <3300000 1
                      1800000 0>;
    };

    vcc_sdhci1: regulator-vcc-sdhci1 {
            compatible = "regulator-fixed";

            regulator-name = "SDHCI1 Vcc";
            regulator-min-microvolt = <3300000>;
            regulator-max-microvolt = <3300000>;
            gpios = <&gpio0 ASPEED_GPIO(V, 2)
                            GPIO_ACTIVE_HIGH>;
            enable-active-high;
    };

    vccq_sdhci1: regulator-vccq-sdhci1 {
            compatible = "regulator-gpio";

            regulator-name = "SDHCI1 VccQ";
            regulator-min-microvolt = <1800000>;
            regulator-max-microvolt = <3300000>;
            gpios = <&gpio0 ASPEED_GPIO(V, 3)
                            GPIO_ACTIVE_HIGH>;
            gpios-states = <1>;
            states = <3300000 1
                      1800000 0>;
    };

    sdc@1e740000 {
            compatible = "aspeed,ast2600-sd-controller";
            reg = <0x1e740000 0x100>;
            #address-cells = <1>;
            #size-cells = <1>;
            ranges = <0 0x1e740000 0x20000>;
            clocks = <&syscon ASPEED_CLK_GATE_SDCLK>;

            sdhci0: sdhci@100 {
                    compatible = "aspeed,ast2600-sdhci", "sdhci";
                    reg = <0x100 0x100>;
                    interrupts = <GIC_SPI 43 IRQ_TYPE_LEVEL_HIGH>;
                    sdhci,auto-cmd12;
                    clocks = <&syscon ASPEED_CLK_SDIO>;
                    vmmc-supply = <&vcc_sdhci0>;
                    vqmmc-supply = <&vccq_sdhci0>;
                    sd-uhs-sdr104;
                    clk-phase-uhs-sdr104 = <180>, <180>;
            };

            sdhci1: sdhci@200 {
                    compatible = "aspeed,ast2600-sdhci", "sdhci";
                    reg = <0x200 0x100>;
                    interrupts = <GIC_SPI 43 IRQ_TYPE_LEVEL_HIGH>;
                    sdhci,auto-cmd12;
                    clocks = <&syscon ASPEED_CLK_SDIO>;
                    vmmc-supply = <&vcc_sdhci1>;
                    vqmmc-supply = <&vccq_sdhci1>;
                    sd-uhs-sdr104;
                    clk-phase-uhs-sdr104 = <0>, <0>;
            };
    };
