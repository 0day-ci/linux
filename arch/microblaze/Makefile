UTS_SYSNAME = -DUTS_SYSNAME=\"uClinux\"

CFLAGS += -g
# r31 holds current when in kernel mode
CFLAGS += -ffixed-r31

ifdef CONFIG_MICROBLAZE_USE_BARREL
CFLAGS += -mxl-barrel-shift
endif

ifdef CONFIG_MICROBLAZE_USE_FPU
CFLAGS += -mhard-float
endif

ifdef CONFIG_MICROBLAZE_USE_PCMP_INSTR
CFLAGS += -mxl-pattern-compare
endif

ifdef CONFIG_MICROBLAZE_USE_DIV
CFLAGS += -mno-xl-soft-mul
endif

ifdef CONFIG_MICROBLAZE_USE_HW_MUL
CFLAGS += -mno-xl-soft-div
endif

LDFLAGS_BLOB := --format binary --oformat elf32-microblaze

LIBGCC := $(shell $(CC) $(CFLAGS) -print-libgcc-file-name)

head-y		:= arch/microblaze/kernel/head.o
libs-y		+= arch/microblaze/lib/ $(LIBGCC)
core-y		+= arch/microblaze/kernel/ arch/microblaze/mm/

boot := arch/microblaze/boot

all: linux.bin

prepare: include/asm-$(ARCH)/asm-offsets.h

arch/$(ARCH)/kernel/asm-offsets.s: include/asm include/linux/version.h

define filechk_gen-asm-offsets
        (set -e; \
         echo "/*"; \
         echo " * DO NOT MODIFY."; \
         echo " *"; \
         echo " * This file was generated by arch/$(ARCH)/Makefile"; \
         echo " *"; \
         echo " */"; \
         echo ""; \
         sed -ne "/^->/{s:^->\([^ ]*\) [\$$#]*\([^ ]*\) \(.*\):#define \1 \2 /* \3 */:; s:->::; p;}"; \
         echo ""; )
endef

include/asm-$(ARCH)/asm-offsets.h: arch/$(ARCH)/kernel/asm-offsets.s
	$(call filechk,gen-asm-offsets)


archclean:
	$(Q)$(MAKE) $(clean)=$(boot)

linux.bin linux.bin.gz: vmlinux
	$(Q)$(MAKE) $(build)=$(boot) $(boot)/$@


CLEAN_FILES += include/asm-$(ARCH)/asm-offsets.h
CLEAN_FILES += arch/$(ARCH)/kernel/asm-offsets.s

define archhelp
  echo  '* linux.bin    - Create raw binary'
  echo  '  linux.bin.gz - Create compressed raw binary'
endef
